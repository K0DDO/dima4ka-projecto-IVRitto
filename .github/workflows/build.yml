name: 🛠️ Godot Engine Builds
on:
  # Schedule updates (once every month)
  schedule:
    - cron: "0 0 1 * *"
  workflow_dispatch:
    inputs:
      make-release:
        description: "Make release"
        required: false
        type: boolean
        default: true
  push:
    branches:
      - main

# Global Settings
# SCONS_CACHE for windows must be set in the build environment
env:
  # Used for cache key as well as for downloading the correct Godot version.
  GODOT_BASE_VERSION: 4.2.2
  GODOT_BASE_VERSION_STATUS: stable
  GODOT_VERSION_STATUS: custom
  GODOT_MONO_BUILD_TAG: release-5299efd # mono-6.12.0.182
  GODOT_MONO_BUILD_REPO: godotengine/godot-mono-builds

jobs:
  linux:
    # Based on https://github.com/godotengine/godot-build-scripts/blob/3.x/build-linux/build.sh
    runs-on: "ubuntu-latest"
    name: 🐧 Linux ${{ matrix.name }}
    env:
      SCONSFLAGS: mono_static=yes
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Editor & Templates
            cache-name: linux
            build-mono: false

          - name: Editor & Templates w/ Mono
            cache-name: linux-mono
            build-mono: true

    steps:
      # region Setup
      - uses: actions/checkout@v3

      - name: Download Godot
        uses: ./.github/actions/godot-download
        with:
          version: ${{ env.GODOT_BASE_VERSION }}-${{ env.GODOT_BASE_VERSION_STATUS }}

      - name: Linux dependencies
        shell: bash
        run: |
          sudo apt-get install xvfb libc6-dev

      # region    Linux Toolchain Setup
      - name: Setup Linux toolchain (x86_64)
        uses: ./.github/actions/godot-linux-toolchain
        with:
          toolchain-name: "x86_64-godot-linux-gnu_sdk-buildroot"

      - name: Setup Linux toolchain (i686)
        uses: ./.github/actions/godot-linux-toolchain
        with:
          toolchain-name: "i686-godot-linux-gnu_sdk-buildroot"
      # endregion

      - name: Setup Godot build cache
        uses: ./.github/actions/godot-cache
        with:
          cache-name: ${{ matrix.cache-name }}
        continue-on-error: true

      - name: Setup python and scons
        uses: ./.github/actions/godot-deps
      # endregion

      # region Mono Setup
      - name: Setup mono (x86_64)
        if: ${{ matrix.build-mono }}
        uses: ./.github/actions/godot-mono
        with:
          mono-release: "linux-x86_64"
          mono-bcl: "bcl-desktop"

      - name: Setup mono (x86)
        if: ${{ matrix.build-mono }}
        uses: ./.github/actions/godot-mono
        with:
          mono-release: "linux-x86"

      - name: Mono precompilation
        if: ${{ matrix.build-mono }}
        uses: ./.github/actions/godot-build
        with:
          buildroot: "${{ github.workspace }}/x86_64-godot-linux-gnu_sdk-buildroot/bin"
          sconsflags: ${{ env.SCONSFLAGS }} ${{ matrix.sconsflags }} module_mono_enabled=yes mono_glue=no copy_mono_root=yes mono_bcl=$HOME/mono-bcls/desktop-bcl/net_4_x mono_prefix=$HOME/mono-installs/desktop-linux-x86_64-release
          platform: linuxbsd
          tools: true

      # Generate mono glue
      - name: Generate Mono glue code
        if: ${{ matrix.build-mono }}
        run: |
          DRI_PRIME=0 xvfb-run "./bin/godot.x11.tools.64.mono" --generate-mono-glue modules/mono/glue || true

      - name: Set Mono scons flags
        if: ${{ matrix.build-mono }}
        run: |
          echo "MONO_SCONSFLAGS=module_mono_enabled=yes mono_glue=yes copy_mono_root=yes mono_bcl=$HOME/mono-bcls/desktop-bcl/net_4_x" >> $GITHUB_ENV

      - name: Clear bin
        run: |
          rm -rf bin
      # endregion
      # region Editor

      # region    (bits=64)
      - name: Compilation (bits=64)
        uses: ./.github/actions/godot-build
        with:
          buildroot: "${{ github.workspace }}/x86_64-godot-linux-gnu_sdk-buildroot/bin"
          sconsflags: ${{ env.SCONSFLAGS }} ${{ env.MONO_SCONSFLAGS }} ${{ matrix.sconsflags }} bits=64 ${{ matrix.build-mono && 'mono_prefix=$HOME/mono-installs/desktop-linux-x86_64-release' || '' }}
          platform: linuxbsd
          target: template_debug
          tools: true

      - name: Upload Editor (bits=64)
        uses: ./.github/actions/upload-artifact
        with:
          name: ${{ matrix.cache-name }}-editor-64

      - name: Clear bin
        run: |
          rm -rf bin
      # endregion
      # region    (bits=32)
      - name: Compilation (bits=32)
        uses: ./.github/actions/godot-build
        with:
          buildroot: "${{ github.workspace }}/i686-godot-linux-gnu_sdk-buildroot/bin"
          sconsflags: ${{ env.SCONSFLAGS }} ${{ env.MONO_SCONSFLAGS }} ${{ matrix.sconsflags }} bits=32 ${{ matrix.build-mono && 'mono_prefix=$HOME/mono-installs/desktop-linux-x86-release' || '' }}
          platform: linuxbsd
          target: template_debug
          tools: true

      - name: Upload Editor (bits=32)
        uses: ./.github/actions/upload-artifact
        with:
          name: ${{ matrix.cache-name }}-editor-32

      - name: Clear bin
        run: |
          rm -rf bin
      # endregion
      # endregion

      # region Templates

      # region    (bits=64)
      - name: Compilation (tools=false, bits=64, target=template_debug)
        uses: ./.github/actions/godot-build
        with:
          buildroot: "${{ github.workspace }}/x86_64-godot-linux-gnu_sdk-buildroot/bin"
          sconsflags: ${{ env.SCONSFLAGS }} ${{ env.MONO_SCONSFLAGS }} ${{ matrix.sconsflags }} bits=64 ${{ matrix.build-mono && 'mono_prefix=$HOME/mono-installs/desktop-linux-x86_64-release' || '' }}
          platform: linuxbsd
          target: template_debug
          tools: false

      - name: Compilation (tools=false, bits=64, target=release)
        uses: ./.github/actions/godot-build
        with:
          buildroot: "${{ github.workspace }}/x86_64-godot-linux-gnu_sdk-buildroot/bin"
          sconsflags: ${{ env.SCONSFLAGS }} ${{ env.MONO_SCONSFLAGS }} ${{ matrix.sconsflags }} bits=64 ${{ matrix.build-mono && 'mono_prefix=$HOME/mono-installs/desktop-linux-x86_64-release' || '' }} debug_symbols=no
          platform: linuxbsd
          target: release
          tools: false

      - name: Upload Templates (bits=64)
        uses: ./.github/actions/upload-artifact
        with:
          name: ${{ matrix.cache-name }}-templates-64

      - name: Clear bin
        run: |
          rm -rf bin
      # endregion
      # region    (bits=32)
      - name: Compilation (bits=32, target=template_debug)
        uses: ./.github/actions/godot-build
        with:
          buildroot: "${{ github.workspace }}/i686-godot-linux-gnu_sdk-buildroot/bin"
          sconsflags: ${{ env.SCONSFLAGS }} ${{ env.MONO_SCONSFLAGS }} ${{ matrix.sconsflags }} bits=32 ${{ matrix.build-mono && 'mono_prefix=$HOME/mono-installs/desktop-linux-x86-release' || '' }}
          platform: linuxbsd
          target: template_debug
          tools: false

      - name: Compilation (bits=32, target=release)
        uses: ./.github/actions/godot-build
        with:
          buildroot: "${{ github.workspace }}/i686-godot-linux-gnu_sdk-buildroot/bin"
          sconsflags: ${{ env.SCONSFLAGS }} ${{ env.MONO_SCONSFLAGS }} ${{ matrix.sconsflags }} bits=32 ${{ matrix.build-mono && 'mono_prefix=$HOME/mono-installs/desktop-linux-x86-release' || '' }} debug_symbols=no
          platform: linuxbsd
          target: release
          tools: false

      - name: Upload Templates (bits=32)
        uses: ./.github/actions/upload-artifact
        with:
          name: ${{ matrix.cache-name }}-templates-32

      - name: Clear bin
        run: |
          rm -rf bin
      # endregion

      # endregion

  macos:
    # Based on https://github.com/godotengine/godot-build-scripts/blob/3.x/build-macosx/build.sh
    runs-on: "macos-latest"
    name: 🍎 macOS ${{ matrix.name }}
    env:
      SCONSFLAGS:
      STRIP: "strip -u -r"
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Editor & Templates
            cache-name: macos
            build-mono: false

          - name: Editor & Templates w/ Mono
            cache-name: macos-mono
            build-mono: true

    steps:
      # region Setup
      - uses: actions/checkout@v3

      - name: Download Godot
        uses: ./.github/actions/godot-download
        with:
          version: ${{ env.GODOT_BASE_VERSION }}-${{ env.GODOT_BASE_VERSION_STATUS }}

      - name: Setup Godot build cache
        uses: ./.github/actions/godot-cache
        with:
          cache-name: ${{ matrix.cache-name }}
        continue-on-error: true

      - name: Setup python and scons
        uses: ./.github/actions/godot-deps
      # endregion

      # region Mono Setup
      - name: Setup mono (x86_64)
        if: ${{ matrix.build-mono }}
        uses: ./.github/actions/godot-mono
        with:
          mono-release: "osx-x86_64"
          mono-bcl: "bcl-desktop"

      - name: Setup mono (arm64)
        if: ${{ matrix.build-mono }}
        uses: ./.github/actions/godot-mono
        with:
          mono-release: "osx-arm64"

      - name: Mono precompilation
        if: ${{ matrix.build-mono }}
        uses: ./.github/actions/godot-build
        with:
          sconsflags: ${{ env.SCONSFLAGS }} ${{ matrix.sconsflags }} module_mono_enabled=yes mono_glue=no
          platform: osx
          tools: true

      # Generate mono glue
      - name: Generate Mono glue code
        if: ${{ matrix.build-mono }}
        run: |
          DRI_PRIME=0 "./bin/godot.osx.tools.64.mono" --generate-mono-glue modules/mono/glue

      - name: Set Mono scons flags
        if: ${{ matrix.build-mono }}
        run: |
          echo "MONO_SCONSFLAGS=module_mono_enabled=yes mono_glue=yes copy_mono_root=yes mono_bcl=$HOME/mono-bcls/desktop-bcl/net_4_x" >> $GITHUB_ENV

      - name: Clear bin
        run: |
          rm -rf bin
      # endregion
      # region Editor
      - name: Compilation (arch=x86_64)
        uses: ./.github/actions/godot-build
        with:
          sconsflags: ${{ env.SCONSFLAGS }} ${{ env.MONO_SCONSFLAGS }} ${{ matrix.sconsflags }} arch=x86_64 ${{ matrix.build-mono && 'mono_prefix=$HOME/mono-installs/desktop-osx-x86_64-release' || '' }}
          platform: osx
          target: template_debug
          tools: true

      - name: Dylib Wrangling
        if: ${{ matrix.build-mono }}
        run: |
          # Note: A bit of dylib wrangling involved as x86_64 and arm64 builds both generate GodotSharp
          # so the second build overrides the first, but we need to lipo the libs to make them universal.
          # We also need to ensure that /etc/mono/config has the proper filenames (keep arm64 as the last
          # build so that we rely on its config, which has libmono-native.dylib instead of
          # libmono-native-compat.dylib).
          mkdir -p tmp-lib/{x86_64,arm64}
          cp bin/GodotSharp/Mono/lib/*.dylib tmp-lib/x86_64/

      - name: Compilation (arch=arm64)
        uses: ./.github/actions/godot-build
        with:
          sconsflags: ${{ env.SCONSFLAGS }} ${{ env.MONO_SCONSFLAGS }} ${{ matrix.sconsflags }} arch=arm64 ${{ matrix.build-mono && 'mono_prefix=$HOME/mono-installs/desktop-osx-arm64-release' || '' }}
          platform: osx
          target: template_debug
          tools: true

      - name: Dylib Wrangling
        if: ${{ matrix.build-mono }}
        run: |
          cp bin/GodotSharp/Mono/lib/*.dylib tmp-lib/arm64/
          echo "tmp-lib:"
          find tmp-lib | sed -e "s/[^-][^\/]*\// |/g" -e "s/|\([^ ]\)/|-\1/"

      - name: Package Editor (arch=arm64, x86_64)
        run: |
          lipo -create bin/godot.osx.opt.tools.x86_64${{ matrix.build-mono && '.mono' || '' }} \
            bin/godot.osx.opt.tools.arm64${{ matrix.build-mono && '.mono' || '' }} \
            -output bin/godot.osx.opt.tools.universal${{ matrix.build-mono && '.mono' || '' }}
          $STRIP bin/godot.osx.opt.tools.universal${{ matrix.build-mono && '.mono' || '' }}

          if ${{ matrix.build-mono }}; then
            # Make universal versions of the dylibs we use.
            lipo -create tmp-lib/x86_64/libmono-native.dylib tmp-lib/arm64/libmono-native.dylib -output tmp-lib/libmono-native.dylib
            lipo -create tmp-lib/x86_64/libMonoPosixHelper.dylib tmp-lib/arm64/libMonoPosixHelper.dylib -output tmp-lib/libMonoPosixHelper.dylib
            # Somehow only included in x86_64 build.
            cp tmp-lib/x86_64/libmono-btls-shared.dylib tmp-lib/

            cp -f tmp-lib/*.dylib bin/GodotSharp/Mono/lib/
          fi

      - name: Upload Editor
        uses: ./.github/actions/upload-artifact
        with:
          name: ${{ matrix.cache-name }}-editor

      - name: Clear bin
        run: |
          rm -rf bin
      # endregion
      # region Templates
      - name: Compilation (tools=false, arch=x86_64, target=template_debug)
        uses: ./.github/actions/godot-build
        with:
          sconsflags: ${{ env.SCONSFLAGS }} ${{ env.MONO_SCONSFLAGS }} ${{ matrix.sconsflags }} arch=x86_64 ${{ matrix.build-mono && 'mono_prefix=$HOME/mono-installs/desktop-osx-x86_64-release' || '' }}
          platform: osx
          target: template_debug
          tools: false

      - name: Compilation (tools=false, arch=arm64, target=template_debug)
        uses: ./.github/actions/godot-build
        with:
          sconsflags: ${{ env.SCONSFLAGS }} ${{ env.MONO_SCONSFLAGS }} ${{ matrix.sconsflags }} arch=arm64 ${{ matrix.build-mono && 'mono_prefix=$HOME/mono-installs/desktop-osx-arm64-release' || '' }}
          platform: osx
          target: template_debug
          tools: false

      - name: Compilation (tools=false, arch=x86_64, target=release)
        uses: ./.github/actions/godot-build
        with:
          sconsflags: ${{ env.SCONSFLAGS }} ${{ env.MONO_SCONSFLAGS }} ${{ matrix.sconsflags }} arch=x86_64 ${{ matrix.build-mono && 'mono_prefix=$HOME/mono-installs/desktop-osx-x86_64-release' || '' }} debug_symbols=no
          platform: osx
          target: release
          tools: false

      - name: Compilation (tools=false, arch=arm64, target=release)
        uses: ./.github/actions/godot-build
        with:
          sconsflags: ${{ env.SCONSFLAGS }} ${{ env.MONO_SCONSFLAGS }} ${{ matrix.sconsflags }} arch=arm64 ${{ matrix.build-mono && 'mono_prefix=$HOME/mono-installs/desktop-osx-arm64-release' || '' }} debug_symbols=no
          platform: osx
          target: release
          tools: false

      - name: Package Templates (arch=arm64, x86_64)
        run: |
          lipo -create bin/godot.osx.opt.debug.x86_64${{ matrix.build-mono && '.mono' || '' }} bin/godot.osx.opt.debug.arm64${{ matrix.build-mono && '.mono' || '' }} -output bin/godot.osx.opt.debug.universal${{ matrix.build-mono && '.mono' || '' }}
          $STRIP bin/godot.osx.opt.debug.universal${{ matrix.build-mono && '.mono' || '' }}
          lipo -create bin/godot.osx.opt.x86_64${{ matrix.build-mono && '.mono' || '' }} bin/godot.osx.opt.arm64${{ matrix.build-mono && '.mono' || '' }} -output bin/godot.osx.opt.universal${{ matrix.build-mono && '.mono' || '' }}
          $STRIP bin/godot.osx.opt.universal${{ matrix.build-mono && '.mono' || '' }}

          if ${{ matrix.build-mono }}; then
            cp -f tmp-lib/*.dylib bin/data.mono.osx.64.release/Mono/lib/
            cp -f tmp-lib/*.dylib bin/data.mono.osx.64.template_debug/Mono/lib/
          fi

      - name: Upload Templates
        uses: ./.github/actions/upload-artifact
        with:
          name: ${{ matrix.cache-name }}-templates

      - name: Clear bin
        run: |
          rm -rf bin
      # endregion

  windows-64:
    runs-on: "ubuntu-latest"
    name: 🏁 Windows-64 ${{ matrix.name }}
    env:
      SCONSFLAGS: use_mingw=yes
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Editor & Templates
            cache-name: windows-64
            artifact-name: windows
            build-mono: false

          - name: Editor & Templates w/ Mono
            cache-name: windows-64-mono
            artifact-name: windows-mono
            build-mono: true

    steps:
      # region Setup
      - uses: actions/checkout@v3

      - name: Download Godot
        uses: ./.github/actions/godot-download
        with:
          version: ${{ env.GODOT_BASE_VERSION }}-${{ env.GODOT_BASE_VERSION_STATUS }}

      - name: Linux dependencies
        shell: bash
        run: |
          sudo apt-get update
          # The actual dependencies
          sudo apt-get install build-essential pkg-config libx11-dev libxcursor-dev \
              libxinerama-dev libgl1-mesa-dev libglu-dev libasound2-dev libpulse-dev \
              libdbus-1-dev libudev-dev libxi-dev libxrandr-dev yasm xvfb unzip \
              libspeechd-dev speech-dispatcher libgl1-mesa-glx
          sudo apt-get -f install

      - name: Windows dependencies
        shell: bash
        run: |
          sudo apt-get install mingw-w64
          echo "1" | sudo update-alternatives --config x86_64-w64-mingw32-gcc
          echo "1" | sudo update-alternatives --config x86_64-w64-mingw32-g++
          echo "1" | sudo update-alternatives --config i686-w64-mingw32-gcc
          echo "1" | sudo update-alternatives --config i686-w64-mingw32-g++

      - name: Setup Godot build cache
        uses: ./.github/actions/godot-cache
        with:
          cache-name: ${{ matrix.cache-name }}
        continue-on-error: true

      - name: Setup python and scons
        uses: ./.github/actions/godot-deps
      # endregion

      # region Mono Setup
      # Assume mono is already installed on the runner
      - name: Setup mono (x86_64)
        if: ${{ matrix.build-mono }}
        uses: ./.github/actions/godot-mono
        with:
          mono-bcl: "bcl-desktop-win32"
          mono-release: "windows-x86_64"

      - name: Setup mono (linux-x86_64)
        if: ${{ matrix.build-mono }}
        uses: ./.github/actions/godot-mono
        with:
          mono-release: "linux-x86_64"

      - name: Mono precompilation
        if: ${{ matrix.build-mono }}
        uses: ./.github/actions/godot-build
        with:
          sconsflags: mono_static=yes module_mono_enabled=yes mono_glue=no
          platform: linuxbsd
          tools: true

      # Generate mono glue
      - name: Generate Mono glue code
        if: ${{ matrix.build-mono }}
        run: |
          DRI_PRIME=0 xvfb-run "./bin/godot.x11.tools.64.mono" --generate-mono-glue modules/mono/glue || true

      - name: Set Mono scons flags
        if: ${{ matrix.build-mono }}
        run: |
          echo "MONO_SCONSFLAGS=module_mono_enabled=yes mono_glue=yes copy_mono_root=yes mono_bcl=$HOME/mono-bcls/desktop-win32-bcl/net_4_x-win32 mono_static=yes" >> $GITHUB_ENV

      - name: Clear bin
        run: |
          rm -rf bin
      # endregion
      # region Editor

      # region    (bits=64)
      - name: Compilation (bits=64)
        uses: ./.github/actions/godot-build
        with:
          sconsflags: ${{ env.SCONSFLAGS }} ${{ env.MONO_SCONSFLAGS }} ${{ matrix.sconsflags }} bits=64 ${{ matrix.build-mono && 'mono_prefix=$HOME/mono-installs/desktop-windows-x86_64-release' || '' }}
          platform: windows
          target: template_debug
          tools: true

      - name: Upload Editor
        uses: ./.github/actions/upload-artifact
        with:
          name: ${{ matrix.artifact-name }}-editor-64

      - name: Clear bin
        run: |
          rm -rf bin
      # endregion
      # endregion

      # region Templates

      # region    (bits=64)
      - name: Compilation (tools=false, bits=64, target=template_debug)
        uses: ./.github/actions/godot-build
        with:
          sconsflags: ${{ env.SCONSFLAGS }} ${{ env.MONO_SCONSFLAGS }} ${{ matrix.sconsflags }} bits=64 ${{ matrix.build-mono && 'mono_prefix=$HOME/mono-installs/desktop-windows-x86_64-release' || '' }}
          platform: windows
          target: template_debug
          tools: false

      - name: Compilation (tools=false, bits=64, target=release)
        uses: ./.github/actions/godot-build
        with:
          sconsflags: ${{ env.SCONSFLAGS }} ${{ env.MONO_SCONSFLAGS }} ${{ matrix.sconsflags }} bits=64 ${{ matrix.build-mono && 'mono_prefix=$HOME/mono-installs/desktop-windows-x86_64-release' || '' }} debug_symbols=no
          platform: windows
          target: release
          tools: false

      - name: Upload Templates
        uses: ./.github/actions/upload-artifact
        with:
          name: ${{ matrix.artifact-name }}-templates-64

      - name: Clear bin
        run: |
          rm -rf bin
      # endregion

      # endregion

  bundle-export-templates:
    needs:
      [linux, macos, windows-64]
    name: Bundle Export Templates
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Templates
            build-mono: false

          - name: Templates w/ Mono
            build-mono: true
    steps:
      # region Setup
      - uses: actions/checkout@v3

      - name: Download Godot
        uses: ./.github/actions/godot-download
        with:
          version: ${{ env.GODOT_BASE_VERSION }}-${{ env.GODOT_BASE_VERSION_STATUS }}

      # region    Download Templates
      - name: Download Linux Templates (bits=64)
        uses: actions/download-artifact@v3
        with:
          name: linux-${{ matrix.build-mono && 'mono-' || '' }}templates-64
          path: linux-${{ matrix.build-mono && 'mono-' || '' }}templates-64

      - name: Download Linux Templates (bits=32)
        uses: actions/download-artifact@v3
        with:
          name: linux-${{ matrix.build-mono && 'mono-' || '' }}templates-32
          path: linux-${{ matrix.build-mono && 'mono-' || '' }}templates-32

      - name: Download Windows Templates (bits=64)
        uses: actions/download-artifact@v3
        with:
          name: windows-${{ matrix.build-mono && 'mono-' || '' }}templates-64
          path: windows-${{ matrix.build-mono && 'mono-' || '' }}templates-64

      - name: Download Windows Templates (bits=32)
        uses: actions/download-artifact@v3
        with:
          name: windows-${{ matrix.build-mono && 'mono-' || '' }}templates-32
          path: windows-${{ matrix.build-mono && 'mono-' || '' }}templates-32

      - name: Download MacOS Templates
        uses: actions/download-artifact@v3
        with:
          name: macos-${{ matrix.build-mono && 'mono-' || '' }}templates
          path: macos-${{ matrix.build-mono && 'mono-' || '' }}templates

      # region    Download Mono Editors
      # These are used for fetching the BCL libraries
      - name: Download Linux Mono Editor (bits=64)
        uses: actions/download-artifact@v3
        if: ${{ matrix.build-mono }}
        with:
          name: linux-mono-editor-64
          path: linux-mono-editor-64

      - name: Download Windows Mono Editor (bits=64)
        uses: actions/download-artifact@v3
        if: ${{ matrix.build-mono }}
        with:
          name: windows-mono-editor-64
          path: windows-mono-editor-64
      # endregion

      - name: Debug Print
        run: |
          ls -a
      # endregion
      - name: Setup ENV Vars
        run: |
          echo "TEMPLATES_VERSION=${{ format('{0}.{1}', env.GODOT_BASE_VERSION, env.GODOT_VERSION_STATUS) }}${{ matrix.build-mono && '.mono' || '' }}" >> $GITHUB_ENV

          echo "RELDIR=$HOME/releases" >> $GITHUB_ENV
          echo "GODOT_BASENAME=Godot_v${{ format('{0}-{1}', env.GODOT_BASE_VERSION, env.GODOT_VERSION_STATUS) }}" >> $GITHUB_ENV
          echo "TEMPLATES_DIR=$HOME/templates" >> $GITHUB_ENV

      - name: Setup Directories
        run: |
          mkdir -p ${{ env.TEMPLATES_DIR }}
          mkdir -p ${{ env.RELDIR }}

      - name: Bundle Linux
        run: |
          if ${{ matrix.build-mono }}; then
            cp -rp linux-mono-templates-64/data.mono.x11.64.* ${{ env.TEMPLATES_DIR }}/
            cp -rp linux-mono-templates-32/data.mono.x11.32.* ${{ env.TEMPLATES_DIR }}/
            mkdir -p ${{ env.TEMPLATES_DIR }}/bcl
            cp -r linux-mono-editor-64/GodotSharp/Mono/lib/mono/4.5/ ${{ env.TEMPLATES_DIR }}/bcl/net_4_x
          fi
          cp linux-${{ matrix.build-mono && 'mono-' || '' }}templates-64/godot.x11.opt.64${{ matrix.build-mono && '.mono' || '' }} ${{ env.TEMPLATES_DIR }}/linux_x11_64_release
          cp linux-${{ matrix.build-mono && 'mono-' || '' }}templates-64/godot.x11.opt.debug.64${{ matrix.build-mono && '.mono' || '' }} ${{ env.TEMPLATES_DIR }}/linux_x11_64_debug
          cp linux-${{ matrix.build-mono && 'mono-' || '' }}templates-32/godot.x11.opt.32${{ matrix.build-mono && '.mono' || '' }} ${{ env.TEMPLATES_DIR }}/linux_x11_32_release
          cp linux-${{ matrix.build-mono && 'mono-' || '' }}templates-32/godot.x11.opt.debug.32${{ matrix.build-mono && '.mono' || '' }} ${{ env.TEMPLATES_DIR }}/linux_x11_32_debug
          strip ${{ env.TEMPLATES_DIR }}/linux_x11_*

      - name: Bundle Windows
        run: |
          if ${{ matrix.build-mono }}; then
            cp -rp windows-mono-templates-64/data.mono.windows.64.* ${{ env.TEMPLATES_DIR }}/
            cp -rp windows-mono-templates-32/data.mono.windows.32.* ${{ env.TEMPLATES_DIR }}/
            mkdir -p ${{ env.TEMPLATES_DIR }}/bcl
            cp -r windows-mono-editor-64/GodotSharp/Mono/lib/mono/4.5/ ${{ env.TEMPLATES_DIR }}/bcl/net_4_x_win
          fi
          cp windows-${{ matrix.build-mono && 'mono-' || '' }}templates-64/godot.windows.opt.64${{ matrix.build-mono && '.mono' || '' }}.exe ${{ env.TEMPLATES_DIR }}/windows_64_release.exe
          cp windows-${{ matrix.build-mono && 'mono-' || '' }}templates-64/godot.windows.opt.debug.64${{ matrix.build-mono && '.mono' || '' }}.exe ${{ env.TEMPLATES_DIR }}/windows_64_debug.exe
          cp windows-${{ matrix.build-mono && 'mono-' || '' }}templates-32/godot.windows.opt.32${{ matrix.build-mono && '.mono' || '' }}.exe ${{ env.TEMPLATES_DIR }}/windows_32_release.exe
          cp windows-${{ matrix.build-mono && 'mono-' || '' }}templates-32/godot.windows.opt.debug.32${{ matrix.build-mono && '.mono' || '' }}.exe ${{ env.TEMPLATES_DIR }}/windows_32_debug.exe
          strip ${{ env.TEMPLATES_DIR }}/windows*.exe

      - name: Bundle MacOS
        run: |
          rm -rf osx_template.app
          cp -r misc/dist/osx_template.app .
          mkdir -p osx_template.app/Contents/MacOS
          cp macos-${{ matrix.build-mono && 'mono-' || '' }}templates/godot.osx.opt.universal${{ matrix.build-mono && '.mono' || '' }} osx_template.app/Contents/MacOS/godot_osx_release.64
          cp macos-${{ matrix.build-mono && 'mono-' || '' }}templates/godot.osx.opt.debug.universal${{ matrix.build-mono && '.mono' || '' }} osx_template.app/Contents/MacOS/godot_osx_debug.64
          if ${{ matrix.build-mono }}; then
            cp -rp macos-mono-templates/data.mono.osx.64.* osx_template.app/Contents/Resources/
          fi
          chmod +x osx_template.app/Contents/MacOS/godot_osx*
          zip -q -9 -r "${{ env.TEMPLATES_DIR }}/osx.zip" osx_template.app
          rm -rf osx_template.app
          # TODO: Create MacOS signing
          # sign_macos_template ${{ env.TEMPLATES_DIR }} 0

      - name: Create Templates TPZ
        run: |
          echo "${{ env.TEMPLATES_VERSION }}" > ${{ env.TEMPLATES_DIR }}/version.txt
          pushd ${{ env.TEMPLATES_DIR }}/..
          zip -q -9 -r -D "${{ env.RELDIR }}/${{ env.GODOT_BASENAME }}_export-templates${{ matrix.build-mono && '-mono' || '' }}.tpz" templates/*
          popd

      - name: Upload Export Templates TPZ
        uses: ./.github/actions/upload-artifact
        with:
          path: ${{ env.RELDIR }}/${{ env.GODOT_BASENAME }}_export-templates${{ matrix.build-mono && '-mono' || '' }}.tpz
          name: export-templates${{ matrix.build-mono && '-mono' || '' }}

  create-release:
    if: success() && (
      (github.event_name == 'push') ||
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && inputs.make-release)
      )
    needs:
      [
        linux,
        macos,
        windows-64,
        bundle-export-templates,
      ]
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag-name.outputs.tag }}
    steps:
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d(%H-%M-%S)')" >> $GITHUB_OUTPUT

      - name: Short SHA
        id: short-sha
        run: echo "sha7=$(echo ${GITHUB_SHA} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Tag Name
        id: tag-name
        run: echo "tag=release-${{ steps.short-sha.outputs.sha7 }}-${{ steps.date.outputs.date }}" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v0.1.15
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag-name.outputs.tag }}
          name: Release ${{ steps.short-sha.outputs.sha7 }} with ${{ env.GODOT_MONO_BUILD_TAG }}
          body: |
            Godot Mono Build Version: ${{ env.GODOT_MONO_BUILD_TAG }}
          draft: false
          prerelease: false

  upload-release-export-templates:
    if: success() && (
      (github.event_name == 'push') ||
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && inputs.make-release)
      )
    needs: create-release
    name: Upload Release Export Templates
    runs-on: ubuntu-latest
    strategy:
      matrix:
        artifact_name: [
            # Regular builds
            export-templates,

            # Mono builds
            export-templates-mono,
          ]
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{ matrix.artifact_name }}
          path: ./

      - name: Debug
        shell: bash
        run: ls

      - name: Upload Artifact
        uses: softprops/action-gh-release@v0.1.15
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.create-release.outputs.tag }}
          files: ./Godot_v${{ format('{0}-{1}', env.GODOT_BASE_VERSION, env.GODOT_VERSION_STATUS) }}_${{ matrix.artifact_name }}.tpz

  upload-release-artifacts:
    if: success() && (
      (github.event_name == 'push') ||
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && inputs.make-release)
      )
    needs: create-release
    name: Upload Release Artifacts
    runs-on: ubuntu-latest
    strategy:
      matrix:
        artifact_name: [
            # Regular builds
            linux-editor-64,
            linux-editor-32,
            linux-templates-64,
            linux-templates-32,
            windows-editor-64,
            windows-templates-64,
            macos-editor,
            macos-templates,

            # Mono builds
            linux-mono-editor-64,
            linux-mono-editor-32,
            linux-mono-templates-64,
            linux-mono-templates-32,
            windows-mono-editor-64,
            windows-mono-templates-64,
            macos-mono-editor,
            macos-mono-templates,
          ]
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{ matrix.artifact_name }}
          path: ./${{ matrix.artifact_name }}

      - name: Zip Artifact
        run: |
          original_path=$(pwd)
          pushd ${{ matrix.artifact_name }}
          zip -ry ${original_path}/${{ matrix.artifact_name }}.zip *
          popd

      - name: Debug
        shell: bash
        run: ls

      - name: Upload Artifact
        uses: softprops/action-gh-release@v0.1.15
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.create-release.outputs.tag }}
          files: ./${{ matrix.artifact_name }}.zip
