name: 🛠️ Godot Engine Builds
on:
  # Schedule updates (once every month)
  schedule:
    - cron: "0 0 1 * *"
  workflow_dispatch:
    inputs:
      make-release:
        description: "Make release"
        required: false
        type: boolean
        default: true
  push:
    branches:
      - main

# Global Settings
# SCONS_CACHE for windows must be set in the build environment
env:
  # Used for cache key as well as for downloading the correct Godot version.
  GODOT_BASE_VERSION: 4.2.2
  GODOT_BASE_VERSION_STATUS: stable
  GODOT_VERSION_STATUS: custom
  GODOT_MONO_BUILD_TAG: release-5299efd # mono-6.12.0.182
  GODOT_MONO_BUILD_REPO: godotengine/godot-mono-builds

jobs:
  windows-64:
    runs-on: "ubuntu-latest"
    name: 🏁 Windows-64 ${{ matrix.name }}
    env:
      SCONSFLAGS: use_mingw=yes
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Editor & Templates
            cache-name: windows-64
            artifact-name: windows
            build-mono: false

          - name: Editor & Templates w/ Mono
            cache-name: windows-64-mono
            artifact-name: windows-mono
            build-mono: true

    steps:
      # region Setup
      - uses: actions/checkout@v3

      - name: Download Godot
        uses: ./.github/actions/godot-download
        with:
          version: ${{ env.GODOT_BASE_VERSION }}-${{ env.GODOT_BASE_VERSION_STATUS }}

      - name: Windows dependencies
        shell: bash
        run: |
          sudo apt-get install mingw-w64
          echo "1" | sudo update-alternatives --config x86_64-w64-mingw32-gcc
          echo "1" | sudo update-alternatives --config x86_64-w64-mingw32-g++
          echo "1" | sudo update-alternatives --config i686-w64-mingw32-gcc
          echo "1" | sudo update-alternatives --config i686-w64-mingw32-g++

      - name: Setup Godot build cache
        uses: ./.github/actions/godot-cache
        with:
          cache-name: ${{ matrix.cache-name }}
        continue-on-error: true

      - name: Setup python and scons
        uses: ./.github/actions/godot-deps
      # endregion

      # region Mono Setup
      # Assume mono is already installed on the runner
      - name: Setup mono (x86_64)
        if: ${{ matrix.build-mono }}
        uses: ./.github/actions/godot-mono
        with:
          mono-bcl: "bcl-desktop-win32"
          mono-release: "windows-x86_64"

      # Generate mono glue
      - name: Generate Mono glue code
        if: ${{ matrix.build-mono }}
        run: |
          DRI_PRIME=0 xvfb-run "./bin/godot.x11.tools.64.mono" --generate-mono-glue modules/mono/glue || true

      - name: Set Mono scons flags
        if: ${{ matrix.build-mono }}
        run: |
          echo "MONO_SCONSFLAGS=module_mono_enabled=yes mono_glue=yes copy_mono_root=yes mono_bcl=$HOME/mono-bcls/desktop-win32-bcl/net_4_x-win32 mono_static=yes" >> $GITHUB_ENV

      - name: Clear bin
        run: |
          rm -rf bin
      # endregion
      # region Editor

      # region    (bits=64)
      - name: Compilation (bits=64)
        uses: ./.github/actions/godot-build
        with:
          sconsflags: ${{ env.SCONSFLAGS }} ${{ env.MONO_SCONSFLAGS }} ${{ matrix.sconsflags }} bits=64 ${{ matrix.build-mono && 'mono_prefix=$HOME/mono-installs/desktop-windows-x86_64-release' || '' }}
          platform: windows
          target: template_debug
          tools: true

      - name: Upload Editor
        uses: ./.github/actions/upload-artifact
        with:
          name: ${{ matrix.artifact-name }}-editor-64

      - name: Clear bin
        run: |
          rm -rf bin
      # endregion
      # endregion

      # region Templates

      # region    (bits=64)
      - name: Compilation (tools=false, bits=64, target=template_debug)
        uses: ./.github/actions/godot-build
        with:
          sconsflags: ${{ env.SCONSFLAGS }} ${{ env.MONO_SCONSFLAGS }} ${{ matrix.sconsflags }} bits=64 ${{ matrix.build-mono && 'mono_prefix=$HOME/mono-installs/desktop-windows-x86_64-release' || '' }}
          platform: windows
          target: template_debug
          tools: false

      - name: Compilation (tools=false, bits=64, target=template_release)
        uses: ./.github/actions/godot-build
        with:
          sconsflags: ${{ env.SCONSFLAGS }} ${{ env.MONO_SCONSFLAGS }} ${{ matrix.sconsflags }} bits=64 ${{ matrix.build-mono && 'mono_prefix=$HOME/mono-installs/desktop-windows-x86_64-release' || '' }} debug_symbols=no
          platform: windows
          target: release
          tools: false

      - name: Upload Templates
        uses: ./.github/actions/upload-artifact
        with:
          name: ${{ matrix.artifact-name }}-templates-64

      - name: Clear bin
        run: |
          rm -rf bin
      # endregion

      # endregion

  bundle-export-templates:
    needs:
      [windows-64]
    name: Bundle Export Templates
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Templates
            build-mono: false

          - name: Templates w/ Mono
            build-mono: true
    steps:
      # region Setup
      - uses: actions/checkout@v3

      - name: Download Godot
        uses: ./.github/actions/godot-download
        with:
          version: ${{ env.GODOT_BASE_VERSION }}-${{ env.GODOT_BASE_VERSION_STATUS }}

      - name: Download Windows Templates (bits=64)
        uses: actions/download-artifact@v3
        with:
          name: windows-${{ matrix.build-mono && 'mono-' || '' }}templates-64
          path: windows-${{ matrix.build-mono && 'mono-' || '' }}templates-64

      - name: Download Windows Mono Editor (bits=64)
        uses: actions/download-artifact@v3
        if: ${{ matrix.build-mono }}
        with:
          name: windows-mono-editor-64
          path: windows-mono-editor-64
      # endregion

      - name: Debug Print
        run: |
          ls -a
      # endregion
      - name: Setup ENV Vars
        run: |
          echo "TEMPLATES_VERSION=${{ format('{0}.{1}', env.GODOT_BASE_VERSION, env.GODOT_VERSION_STATUS) }}${{ matrix.build-mono && '.mono' || '' }}" >> $GITHUB_ENV

          echo "RELDIR=$HOME/releases" >> $GITHUB_ENV
          echo "GODOT_BASENAME=Godot_v${{ format('{0}-{1}', env.GODOT_BASE_VERSION, env.GODOT_VERSION_STATUS) }}" >> $GITHUB_ENV
          echo "TEMPLATES_DIR=$HOME/templates" >> $GITHUB_ENV

      - name: Setup Directories
        run: |
          mkdir -p ${{ env.TEMPLATES_DIR }}
          mkdir -p ${{ env.RELDIR }}

      - name: Bundle Windows
        run: |
          if ${{ matrix.build-mono }}; then
            cp -rp windows-mono-templates-64/data.mono.windows.64.* ${{ env.TEMPLATES_DIR }}/
            cp -rp windows-mono-templates-32/data.mono.windows.32.* ${{ env.TEMPLATES_DIR }}/
            mkdir -p ${{ env.TEMPLATES_DIR }}/bcl
            cp -r windows-mono-editor-64/GodotSharp/Mono/lib/mono/4.5/ ${{ env.TEMPLATES_DIR }}/bcl/net_4_x_win
          fi
          cp windows-${{ matrix.build-mono && 'mono-' || '' }}templates-64/godot.windows.opt.64${{ matrix.build-mono && '.mono' || '' }}.exe ${{ env.TEMPLATES_DIR }}/windows_64_release.exe
          cp windows-${{ matrix.build-mono && 'mono-' || '' }}templates-64/godot.windows.opt.debug.64${{ matrix.build-mono && '.mono' || '' }}.exe ${{ env.TEMPLATES_DIR }}/windows_64_debug.exe
          cp windows-${{ matrix.build-mono && 'mono-' || '' }}templates-32/godot.windows.opt.32${{ matrix.build-mono && '.mono' || '' }}.exe ${{ env.TEMPLATES_DIR }}/windows_32_release.exe
          cp windows-${{ matrix.build-mono && 'mono-' || '' }}templates-32/godot.windows.opt.debug.32${{ matrix.build-mono && '.mono' || '' }}.exe ${{ env.TEMPLATES_DIR }}/windows_32_debug.exe
          strip ${{ env.TEMPLATES_DIR }}/windows*.exe

      - name: Create Templates TPZ
        run: |
          echo "${{ env.TEMPLATES_VERSION }}" > ${{ env.TEMPLATES_DIR }}/version.txt
          pushd ${{ env.TEMPLATES_DIR }}/..
          zip -q -9 -r -D "${{ env.RELDIR }}/${{ env.GODOT_BASENAME }}_export-templates${{ matrix.build-mono && '-mono' || '' }}.tpz" templates/*
          popd

      - name: Upload Export Templates TPZ
        uses: ./.github/actions/upload-artifact
        with:
          path: ${{ env.RELDIR }}/${{ env.GODOT_BASENAME }}_export-templates${{ matrix.build-mono && '-mono' || '' }}.tpz
          name: export-templates${{ matrix.build-mono && '-mono' || '' }}

  create-release:
    if: success() && (
      (github.event_name == 'push') ||
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && inputs.make-release)
      )
    needs:
      [
        windows-64,
        bundle-export-templates,
      ]
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag-name.outputs.tag }}
    steps:
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d(%H-%M-%S)')" >> $GITHUB_OUTPUT

      - name: Short SHA
        id: short-sha
        run: echo "sha7=$(echo ${GITHUB_SHA} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Tag Name
        id: tag-name
        run: echo "tag=release-${{ steps.short-sha.outputs.sha7 }}-${{ steps.date.outputs.date }}" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v0.1.15
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag-name.outputs.tag }}
          name: Release ${{ steps.short-sha.outputs.sha7 }} with ${{ env.GODOT_MONO_BUILD_TAG }}
          body: |
            Godot Mono Build Version: ${{ env.GODOT_MONO_BUILD_TAG }}
          draft: false
          prerelease: false

  upload-release-export-templates:
    if: success() && (
      (github.event_name == 'push') ||
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && inputs.make-release)
      )
    needs: create-release
    name: Upload Release Export Templates
    runs-on: ubuntu-latest
    strategy:
      matrix:
        artifact_name: [
            # Regular builds
            export-templates,

            # Mono builds
            export-templates-mono,
          ]
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{ matrix.artifact_name }}
          path: ./

      - name: Debug
        shell: bash
        run: ls

      - name: Upload Artifact
        uses: softprops/action-gh-release@v0.1.15
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.create-release.outputs.tag }}
          files: ./Godot_v${{ format('{0}-{1}', env.GODOT_BASE_VERSION, env.GODOT_VERSION_STATUS) }}_${{ matrix.artifact_name }}.tpz

  upload-release-artifacts:
    if: success() && (
      (github.event_name == 'push') ||
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && inputs.make-release)
      )
    needs: create-release
    name: Upload Release Artifacts
    runs-on: ubuntu-latest
    strategy:
      matrix:
        artifact_name: [
            # Regular builds
            windows-editor-64,
            windows-templates-64,

            # Mono builds
            windows-mono-editor-64,
            windows-mono-templates-64,
          ]
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{ matrix.artifact_name }}
          path: ./${{ matrix.artifact_name }}

      - name: Zip Artifact
        run: |
          original_path=$(pwd)
          pushd ${{ matrix.artifact_name }}
          zip -ry ${original_path}/${{ matrix.artifact_name }}.zip *
          popd

      - name: Debug
        shell: bash
        run: ls

      - name: Upload Artifact
        uses: softprops/action-gh-release@v0.1.15
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.create-release.outputs.tag }}
          files: ./${{ matrix.artifact_name }}.zip
